<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
<title>Urlaubsverwaltung</title>

<link rel="stylesheet" href="lib/ionicons/css/ionicons.min.css" />
<link rel='stylesheet' href='lib/fullcalendar/fullcalendar.css' />
<link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css" />

<script type="text/javascript" src="lib/jquery/jquery-1.11.1.min.js"></script>
<script src="lib/bootstrap/js/bootstrap.min.js"></script>
<script src="lib/fullcalendar/lib/moment.min.js"></script>
<script src="lib/fullcalendar/fullcalendar.js"></script>

<script src="js/client.js"></script>
<script src="js/model.js"></script>

<script type="text/javascript">
	var calendar;
	var dep_new = new Array;
	
/*
*	Entfernt doppelte array Eintraege.
*/
	function array_unique(arrayName) {					
	var newArray = new Array();
	label:for(var i=0; i<arrayName.length;i++ ) {  
		for(var j=0; j<newArray.length;j++ ) {
		        if(newArray[j] == arrayName[i]) 
				continue label;
			}
		        newArray[newArray.length] = arrayName[i];
		}
		return newArray;
	}

/*
*	Füllt das department_menu mit allen Abteilungen.
*/
	function departmentMenu(){							
		var persons = getPersons();
		var dep = new Array;
		var rows = "";
		
			for(var i=0; i<persons.length; i++){
				var person = persons[i];
				dep[i] = person.department;	
			}
			dep_new = array_unique(dep);
			
			for (var i=0; i<dep_new.length; i++){
			rows += "<a id= '"+dep_new[i]+"'role='menuitem' tabindex='-1' onclick='getFilteredHolidayRequests(id)'>"+dep_new[i]+"</a></li>";
			
			$("#department_menu").html(rows);
			}
	}
	
/*
*	Diese Filtermethode geht alle Holidayrequests durch und 
*	gleicht sie mit allen Personen ab, um so an die Abteilungen 
*	zu kommen. Es werden dann alle requests die auf eine Abteilung 
*	passen mit push auf filtersRequests gelegt und dann auf dem Kalender
*  uebermittelt. die push funktion macht aber nicht das was sie soll, 
*  wie man dem cosole.log entnehmen kann werden leere Objekte gepusht?! 
*  weiß einer wieso das so ist?
*	
*	@param  Abteilung nach der gefiltert werden soll.
*	@returns gefiltertes Array mit requestobjekten.
*/
	function getFilteredHolidayRequests(filters) {		
		var requests = getHolidayRequests();				
		var requestId = new Array;
		var persons = getPersons();
		var personId = new Array;
		var personDep = new Array;
		var filtersRequests = [];
			if(filters.length<1){
				console.log("filter leer");
				return filtersRequests;
				}
		for (var i=0; i<requests.length; i++){
			var request = requests[i];
			requestId[i] = request.person;
			
			for (var j=0; j<persons.length; j++){
			var person = persons[j];
			personId[j] = person.id;
			personDep[j] = person.department;

				if(requestId[i] == personId[j]){
					
					if(personDep[i] == filters){
						console.log("juhu");
						console.log(request);
						filtersRequests.push(request);
						console.log(filtersRequests);							
					}
					else{
					filtersRequests.push({});
					console.log(filtersRequests);
					}
				}
			
			}	
		}
		console.log(filtersRequests);
		return filtersRequests;	
	}

	function getActualFilters() {
		return [];
	}

	function unixTS2calendarTS(timestamp) {
		var date = new Date(timestamp * 1000);
		return date.getFullYear() + "-" + (date.getMonth() + 1) + "-"
				+ date.getDate();
	}

	function getCalendarEvents() {
		var events = [];
		var requests = getFilteredHolidayRequests(getActualFilters());

		for (var i = 0; i < requests.length; i++) {
			var request = requests[i];
			var person = getPerson(request.person);
			var title = person.forename + " " + person.lastname;
			var start = unixTS2calendarTS(request.start);
			var end = unixTS2calendarTS(request.end);
			
			events.push({
				title : title,
				start : start,
				end : end
			});
		}

		return events;

	}

	$(document).ready(function() {

		departmentMenu();
		
		calendar = $('#calendar').fullCalendar({
			lang : 'de', 

			header : {
				left : 'prev,next',
				center : 'title',
				right : 'year,month,agendaWeek'
			},
			defaultView : 'year',
			//weekends: false,
			firstDay : 0,

			events : getCalendarEvents()

		});

	});
</script>
</head>

<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<span class="navbar-brand">Urlaubsverwaltung</span>
			</div>
			<div>
				<ul class="nav navbar-nav">
					<li class="active"><a href="#"><span class="ion-home">Übersicht</a></li>
					<li><a href="my.html"><span class="ion-person"></span>
							Mein Kalender</a></li>
					<li><a href="requests.html"><span class="ion-clipboard">Anfragen</a></li>
					<li><a href="admin.php"><span class="ion-clipboard">Admin</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">
		<div class="row">
			<div class="dropdown">
				<button class="btn btn-default dropdown-toggle" type="button"
					id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
					Abteilungen <span class="caret"></span>
				</button>
				<ul class="dropdown-menu" role="menu"
					aria-labelledby="dropdownMenu1">
					<li id ="department_menu"role="presentation"><a role="menuitem" tabindex="-1"
						href="#">Abt1</a></li>
				</ul>
			</div>
		</div>
	</div>
	<div class="container">
		<div class="row">

			<div class="panel panel-default">
				<div class="panel-heading">Kalender</div>
				<div class="panel-body">
					<div id='calendar'></div>
				</div>
			</div>
		</div>
	</div>


</body>

</html>
